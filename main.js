!function(t){var r={};function o(e){if(r[e])return r[e].exports;var n=r[e]={i:e,l:!1,exports:{}};return t[e].call(n.exports,n,n.exports,o),n.l=!0,n.exports}o.m=t,o.c=r,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(n,e){if(1&e&&(n=o(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var t=Object.create(null);if(o.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var r in n)o.d(t,r,function(e){return n[e]}.bind(null,r));return t},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},o.p="",o(o.s=4)}([function(e,n,t){"use strict";var r;Object.defineProperty(n,"__esModule",{value:!0}),n.IncomingMessageType=void 0,(r=n.IncomingMessageType||(n.IncomingMessageType={})).ERROR="ERROR",r.LOGIN="LOGIN",r.LOGOUT="LOGOUT",r.SEND_OFFER="SEND_OFFER",r.SEND_ANSWER="SEND_ANSWER",r.SEND_CANDIDATE="SEND_CANDIDATE"},function(e,n,t){"use strict";var o=this&&this.__awaiter||function(e,s,c,u){return new(c=c||Promise)(function(t,n){function r(e){try{i(u.next(e))}catch(e){n(e)}}function o(e){try{i(u.throw(e))}catch(e){n(e)}}function i(e){var n;e.done?t(e.value):((n=e.value)instanceof c?n:new c(function(e){e(n)})).then(r,o)}i((u=u.apply(e,s||[])).next())})},i=this&&this.__generator||function(t,r){var o,i,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:n(0),throw:n(1),return:n(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(s=2&n[0]?i.return:n[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,n[1])).done)return s;switch(i=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,i=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){c.label=n[1];break}if(6===n[0]&&c.label<s[1]){c.label=s[1],s=n;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(n);break}s[2]&&c.ops.pop(),c.trys.pop();continue}n=r.call(t,c)}catch(e){n=[6,e],i=0}finally{o=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}};Object.defineProperty(n,"__esModule",{value:!0}),n.playAudio=n.captureAudio=void 0,n.captureAudio=function(){return navigator.mediaDevices.getUserMedia({audio:!0})},n.playAudio=function(r){return o(this,void 0,void 0,function(){return i(this,function(e){switch(e.label){case 0:return n=r,(t=document.createElement("audio")).srcObject=n,document.body.appendChild(t),[4,t.play()];case 1:return e.sent(),console.log("playing"),[2]}var n,t})})}},function(e,n,t){"use strict";var a=this&&this.__awaiter||function(e,s,c,u){return new(c=c||Promise)(function(t,n){function r(e){try{i(u.next(e))}catch(e){n(e)}}function o(e){try{i(u.throw(e))}catch(e){n(e)}}function i(e){var n;e.done?t(e.value):((n=e.value)instanceof c?n:new c(function(e){e(n)})).then(r,o)}i((u=u.apply(e,s||[])).next())})},l=this&&this.__generator||function(t,r){var o,i,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:n(0),throw:n(1),return:n(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(s=2&n[0]?i.return:n[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,n[1])).done)return s;switch(i=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,i=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){c.label=n[1];break}if(6===n[0]&&c.label<s[1]){c.label=s[1],s=n;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(n);break}s[2]&&c.ops.pop(),c.trys.pop();continue}n=r.call(t,c)}catch(e){n=[6,e],i=0}finally{o=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}};function f(e){var n=document.querySelector(e);if(n)return n.innerHTML="",n;var t=document.createElement("div");return t.id=e.substr(1),document.body.appendChild(t),t}function d(e,n){var t=document.createElement("button");return t.innerHTML=e,t.style.fontSize="3em",t.style.padding="0.5em",t.onclick=n,t}Object.defineProperty(n,"__esModule",{value:!0}),n.renderUsers=n.renderMessage=n.renderCTA=n.renderUsername=n.forceUserToSetName=void 0,n.forceUserToSetName=function(){for(var e=sessionStorage.getItem("amongus:username");!e;)e=prompt("Username");return sessionStorage.setItem("amongus:username",e),e},n.renderUsername=function(e){f("#username").innerHTML="<h1>"+e+"</h1>"},n.renderCTA=function(e,n){var t=f("#cta"),r=d(e,function(){t.innerHTML="",n()});t.appendChild(document.createElement("hr")),t.appendChild(r)},n.renderMessage=function(e){f("#message").innerHTML=e},n.renderUsers=function o(i,s){for(var c=this,u=f("#userlist"),e=0,n=i;e<n.length;e++)!function(n){function e(){return a(c,void 0,void 0,function(){return l(this,function(e){switch(e.label){case 0:return[4,s(n)];case 1:return e.sent(),o(i,s),[2]}})})}var t=document.createElement("div"),r=n.isCalling?d(n.name+" (colgar)...",e):d(n.name,e);t.appendChild(r),u.appendChild(t)}(n[e])}},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.logAllEvents=void 0,n.logAllEvents=function(e,t){(function(e){var n=[],t=e;for(;t;)n.push.apply(n,Object.keys(t)),t=Object.getPrototypeOf(t);return function(e){return Array.from(new Set(e))}(n)})(e).filter(function(e){return e.startsWith("on")}).map(function(n){return e[n]=function(e){return console.debug(t+' event "'+n+'"',e)}})}},function(e,n,t){"use strict";var i=this&&this.__awaiter||function(e,s,c,u){return new(c=c||Promise)(function(t,n){function r(e){try{i(u.next(e))}catch(e){n(e)}}function o(e){try{i(u.throw(e))}catch(e){n(e)}}function i(e){var n;e.done?t(e.value):((n=e.value)instanceof c?n:new c(function(e){e(n)})).then(r,o)}i((u=u.apply(e,s||[])).next())})},s=this&&this.__generator||function(t,r){var o,i,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:n(0),throw:n(1),return:n(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(s=2&n[0]?i.return:n[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,n[1])).done)return s;switch(i=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,i=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){c.label=n[1];break}if(6===n[0]&&c.label<s[1]){c.label=s[1],s=n;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(n);break}s[2]&&c.ops.pop(),c.trys.pop();continue}n=r.call(t,c)}catch(e){n=[6,e],i=0}finally{o=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}};Object.defineProperty(n,"__esModule",{value:!0});var r=t(0),o=t(5),c=t(1),u=t(2),a=t(6),l=t(7),f=t(12),d=o.OutgoingMessageType,p=new f.Socket("wss://amongus.amatiasq.com");function h(n,e,t){function r(n){return function(e){if(e.from===t.name)return n(e)}}e.onMessage(o.OutgoingMessageType.RECEIVE_ANSWER,r(function(e){return n.receiveAnswer(e.answer)})),e.onMessage(o.OutgoingMessageType.RECEIVE_CANDIDATE,r(function(e){return n.receiveCandidate(e.candidate)}))}a.onUserClicked(function(e){return e.isCalling?e.hangup():function(r){return i(this,void 0,void 0,function(){var n,t;return s(this,function(e){switch(e.label){case 0:return n=new l.PeerConnection(r,function(e){return p.send(e)}),[4,c.captureAudio()];case 1:return t=e.sent(),h(n,p,r),t.getTracks().forEach(function(e){return n.addTrack(e,t)}),n.sendOffer(),r.callStarted(n),[2,n]}})})}(e)}),p.onMessage(d.HANDSHAKE,function(){var e=u.forceUserToSetName();u.renderUsername(e),p.send({type:r.IncomingMessageType.LOGIN,name:e})}),p.onMessage(d.LOGIN_RESULT,function(e){if(e.type!==o.OutgoingMessageType.LOGIN_RESULT)return;if(!e.success)return alert(e.message),sessionStorage.clear(),void location.reload();a.setUserList(e.users)}),p.onMessage(d.USER_CONNECTED,function(e){return a.userConnected(e.user)}),p.onMessage(d.USER_DISCONNECTED,function(e){return a.userDisconnected(e.user)}),p.onMessage(d.RECEIVE_OFFER,function(e){return function(r,o){return i(this,void 0,void 0,function(){var n,t;return s(this,function(e){switch(e.label){case 0:return n=new l.PeerConnection(r,function(e){return p.send(e)}),[4,c.captureAudio()];case 1:return t=e.sent(),h(n,p,r),t.getTracks().forEach(function(e){return n.addTrack(e,t)}),n.receiveOffer(o),r.callStarted(n),[2,n]}})})}(a.getUserByName(e.from),e.offer)})},function(e,n,t){"use strict";var r;Object.defineProperty(n,"__esModule",{value:!0}),n.OutgoingMessageType=void 0,(r=n.OutgoingMessageType||(n.OutgoingMessageType={})).ERROR="ERROR",r.HANDSHAKE="HANDSHAKE",r.LOGIN_RESULT="LOGIN_RESULT",r.USER_CONNECTED="USER_CONNECTED",r.USER_DISCONNECTED="USER_DISCONNECTED",r.RECEIVE_OFFER="RECEIVE_OFFER",r.RECEIVE_ANSWER="RECEIVE_ANSWER",r.RECEIVE_CANDIDATE="RECEIVE_CANDIDATE"},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.User=n.userDisconnected=n.userConnected=n.getUserByName=n.setUserList=n.onUserClicked=void 0;var r,o=t(2),i=[];function s(e){return new c(e)}n.onUserClicked=function(e){r=e},n.setUserList=function(e){i=e.map(s),o.renderUsers(i,r)},n.getUserByName=function(n){var e=i.find(function(e){return e.name===n});if(!e)throw new Error("Can't find user \""+n+'"');return e},n.userConnected=function(e){console.log("CONNECTED",e),i.push(s(e)),o.renderUsers(i,r)},n.userDisconnected=function(n){console.log("DISCONNECTED",n),i=i.filter(function(e){return e.id!==n.id}),o.renderUsers(i,r)};var c=(Object.defineProperty(u.prototype,"isCalling",{get:function(){return Boolean(this.connection)},enumerable:!1,configurable:!0}),u.prototype.callStarted=function(e){this.connection=e},u.prototype.hangup=function(){var e;null!==(e=this.connection)&&void 0!==e&&e.end(),this.connection=null},u);function u(e){this.connection=null,this.id=e.id,this.name=e.name}n.User=c},function(e,n,t){"use strict";var r=this&&this.__awaiter||function(e,s,c,u){return new(c=c||Promise)(function(t,n){function r(e){try{i(u.next(e))}catch(e){n(e)}}function o(e){try{i(u.throw(e))}catch(e){n(e)}}function i(e){var n;e.done?t(e.value):((n=e.value)instanceof c?n:new c(function(e){e(n)})).then(r,o)}i((u=u.apply(e,s||[])).next())})},o=this&&this.__generator||function(t,r){var o,i,s,c={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:n(0),throw:n(1),return:n(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(s=2&n[0]?i.return:n[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,n[1])).done)return s;switch(i=0,s&&(n=[2&n[0],s.value]),n[0]){case 0:case 1:s=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,i=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(!(s=0<(s=c.trys).length&&s[s.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){c.label=n[1];break}if(6===n[0]&&c.label<s[1]){c.label=s[1],s=n;break}if(s&&c.label<s[2]){c.label=s[2],c.ops.push(n);break}s[2]&&c.ops.pop(),c.trys.pop();continue}n=r.call(t,c)}catch(e){n=[6,e],i=0}finally{o=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}};Object.defineProperty(n,"__esModule",{value:!0}),n.PeerConnection=void 0;var i=t(0),s=t(1),c=t(3),u=t(8),a=(l.prototype.sendOffer=function(){return r(this,void 0,void 0,function(){var n;return o(this,function(e){switch(e.label){case 0:return[4,this.createOffer({offerToReceiveAudio:!0})];case 1:return n=e.sent(),[4,this.send({type:i.IncomingMessageType.SEND_OFFER,to:this.user.name,offer:n})];case 2:return e.sent(),[2]}})})},l.prototype.receiveOffer=function(t){return r(this,void 0,void 0,function(){var n;return o(this,function(e){switch(e.label){case 0:return[4,this.setRemoteDescription(t)];case 1:return e.sent(),[4,this.createAnswer({offerToReceiveAudio:!0})];case 2:return n=e.sent(),[4,this.send({type:i.IncomingMessageType.SEND_ANSWER,to:this.user.name,answer:n})];case 3:return e.sent(),[2]}})})},l.prototype.receiveAnswer=function(e){return this.setRemoteDescription(e)},l.prototype.receiveCandidate=function(e){return this.rtc.addIceCandidate(new RTCIceCandidate(e))},l.prototype.addTrack=function(e,n){return this.rtc.addTrack(e,n)},l.prototype.end=function(){this.rtc.close()},l.prototype.createRtc=function(){var t=this,e=new RTCPeerConnection({iceServers:u()});return c.logAllEvents(e,"WebRTC("+this.user.name+")"),e.ontrack=function(e){console.log("got track"),s.playAudio(e.streams[0])},e.ondatachannel=function(e){var n=e.channel;n.onmessage=function(e){return t.onDataChannelMessage(e)},n.onopen=function(){return console.log("Data channel is open and ready to be used.")}},e.onicecandidate=function(e){var n=e.candidate;n&&(console.log("Candidate ready"),t.send({type:i.IncomingMessageType.SEND_CANDIDATE,to:t.user.name,candidate:n}))},e},l.prototype.createDataChannel=function(){var n=this,e=this.rtc.createDataChannel("messenger");return c.logAllEvents(e,"DataChannel("+this.user.name+")"),e.onmessage=function(e){return n.onDataChannelMessage(e)},e},l.prototype.createOffer=function(t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var n;return o(this,function(e){switch(e.label){case 0:return[4,this.rtc.createOffer(t)];case 1:return n=e.sent(),[4,this.rtc.setLocalDescription(n)];case 2:return e.sent(),[2,this.rtc.localDescription]}})})},l.prototype.createAnswer=function(t){return void 0===t&&(t={}),r(this,void 0,void 0,function(){var n;return o(this,function(e){switch(e.label){case 0:return[4,this.rtc.createAnswer(t)];case 1:return n=e.sent(),[4,this.rtc.setLocalDescription(n)];case 2:return e.sent(),[2,this.rtc.localDescription]}})})},l.prototype.setRemoteDescription=function(e){return this.rtc.setRemoteDescription(new RTCSessionDescription(e))},l.prototype.onDataChannelMessage=function(e){console.log("POLLAS",e)},l);function l(e,n){this.user=e,this.send=n,this.rtc=this.createRtc()}n.PeerConnection=a},function(e,n,o){"use strict";var s=o(9);e.exports=function(e){var n,i={stun:(e||{}).stun||o(10),turn:(e||{}).turn||o(11)},t=(e||{}).turnCount||0;function r(n,e){for(var t,r=[],o=[].concat(i[n]);o.length&&r.length<e;)t=Math.random()*o.length|0,r=r.concat(o.splice(t,1));return r.map(function(e){return"string"==typeof e||e instanceof String?s(n+":"+e):e})}return n=[].concat(r("stun",(e||{}).stunCount||2)),t&&(n=n.concat(r("turn",t))),n}},function(e,n){var i=["stun:","turn:"];e.exports=function(e){var n,t,r=(e||{}).url||e,o={};return"string"==typeof r||r instanceof String?(r=r.trim(),(n=i[i.indexOf(r.slice(0,5))])?(t=(r=r.slice(5)).split("@"),o.username=e.username,o.credential=e.credential,1<t.length&&(r=t[1],t=t[0].split(":"),o.username=t[0],o.credential=(e||{}).credential||t[1]||""),o.url=n+r,o.urls=[o.url],o):e):e}},function(e){e.exports=JSON.parse('["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org"]')},function(e){e.exports=JSON.parse("[]")},function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Socket=void 0;var r=t(3),o=(i.prototype.onMessage=function(e,n){this.listeners.has(e)?this.listeners.get(e).push(n):this.listeners.set(e,[n])},i.prototype.send=function(e){this.ws.send(JSON.stringify(e))},i.prototype.init=function(){var n=this,e=new WebSocket("wss://amongus.amatiasq.com");return r.logAllEvents(e,"WebSocket"),e.onerror=function(){return n.reconnect()},e.onclose=function(){return n.reconnect()},e.onmessage=function(e){return n.processMessage(e)},e},i.prototype.reconnect=function(){var e=this;console.warn("Socket closed."),setTimeout(function(){console.warn("Reconnecting..."),e.reconnectionDelay*=2,e.ws=e.init()},this.reconnectionDelay)},i.prototype.processMessage=function(e){this.reconnectionDelay=10;var n=JSON.parse(e.data),t=this.listeners.get(n.type);console.debug(n.type,n),t?t.forEach(function(e){return e(n)}):console.log("Unhandled message: "+n.type)},i);function i(e){this.uri=e,this.reconnectionDelay=10,this.listeners=new Map,this.ws=this.init()}n.Socket=o}]);
//# sourceMappingURL=main.js.map